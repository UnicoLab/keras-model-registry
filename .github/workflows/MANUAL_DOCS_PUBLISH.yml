name: "Manual Documentation Publish (KDP)"

on:
  workflow_dispatch:
    inputs:
      RELEASE_VERSION:
        required: true
        type: string
        description: "Release version for documentation"
      UPDATE_LATEST:
        required: true
        type: boolean
        default: true
        description: "Update the 'latest' alias to point to this version"

permissions:
  contents: write

jobs:
  UPDATE_DOCS:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --only doc --no-interaction

          # Verify mike is installed
          mike --version || pip install mike

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Fetch gh-pages branch
        run: |
          # Fetch the gh-pages branch (create it if it doesn't exist)
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout -b gh-pages && git push origin gh-pages && git checkout main

      - name: Release documentation with mike
        id: deploy_docs
        run: |
          echo "Deploying documentation for version ${{ inputs.RELEASE_VERSION }}"

          # Set up command based on whether to update latest alias
          if [[ "${{ inputs.UPDATE_LATEST }}" == "true" ]]; then
            echo "Updating 'latest' alias to point to version ${{ inputs.RELEASE_VERSION }}"
            COMMAND="mike deploy --push --update-aliases ${{ inputs.RELEASE_VERSION }} latest"
          else
            echo "Not updating 'latest' alias"
            COMMAND="mike deploy --push ${{ inputs.RELEASE_VERSION }}"
          fi

          # Execute the command
          $COMMAND
        continue-on-error: true

      - name: Retry documentation release on failure
        if: steps.deploy_docs.outcome == 'failure'
        run: |
          echo "First documentation deploy attempt failed, retrying..."

          # Try to fetch the latest gh-pages branch, create if it doesn't exist
          if ! git fetch origin gh-pages:gh-pages --force 2>/dev/null; then
            echo "gh-pages branch doesn't exist, creating it..."
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout main
            git fetch origin gh-pages:gh-pages
          fi

          # Set up command based on whether to update latest alias
          if [[ "${{ inputs.UPDATE_LATEST }}" == "true" ]]; then
            mike deploy --push --update-aliases --force ${{ inputs.RELEASE_VERSION }} latest
          else
            mike deploy --push --force ${{ inputs.RELEASE_VERSION }}
          fi
