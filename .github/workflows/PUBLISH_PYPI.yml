name: "Publish to PyPI - UnicoLab"

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      VERSION:
        required: true
        default: 0.1.0
        description: 'Version to publish (e.g., 0.1.0)'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: |
          poetry install --no-interaction
          # Ensure doc dependencies are installed for mike
          poetry install --only doc --no-interaction

      - name: Run tests
        run: poetry run pytest tests/ -v

      - name: Build package
        run: poetry build

      - name: Publish to PyPI
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }}
        run: poetry publish --no-interaction

      - name: Create GitHub Release (if not already created by semantic-release)
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Release ${{ github.ref_name }}
            
            This release was created from tag ${{ github.ref_name }}.
            
            **Package Version:** ${{ github.ref_name }}
            **Published to PyPI:** âœ…
          draft: false
          prerelease: false

      - name: Configure Git for docs deployment
        run: |
          git config user.name "UnicoLab Bot"
          git config user.email "bot@unicolab.ai"

      - name: Fetch gh-pages branch
        run: |
          # Fetch the gh-pages branch (create it if it doesn't exist)
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout -b gh-pages && git push origin gh-pages && git checkout main

      - name: Deploy documentation
        id: deploy_docs
        continue-on-error: true
        run: |
          # Configure git authentication for mike
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          # Extract version from tag (remove 'v' prefix if present) or use poetry version
          if [[ "${{ github.ref_name }}" =~ ^v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          # Verify version matches poetry version (source of truth)
          POETRY_VERSION=$(poetry version -s)
          if [ "$VERSION" != "$POETRY_VERSION" ]; then
            echo "Warning: Tag version ($VERSION) does not match poetry version ($POETRY_VERSION)"
            echo "Using poetry version as source of truth: $POETRY_VERSION"
            VERSION="$POETRY_VERSION"
          fi
          echo "Deploying documentation version: $VERSION (building from current code)"
          poetry run mike deploy --push --update-aliases "$VERSION" latest

      - name: Retry documentation release on failure
        if: steps.deploy_docs.outcome == 'failure'
        run: |
          echo "First documentation deploy attempt failed, retrying..."

          # Try to fetch the latest gh-pages branch, create if it doesn't exist
          if ! git fetch origin gh-pages:gh-pages --force 2>/dev/null; then
            echo "gh-pages branch doesn't exist, creating it..."
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout main
            git fetch origin gh-pages:gh-pages
          fi

          if [[ "${{ github.ref_name }}" =~ ^v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          POETRY_VERSION=$(poetry version -s)
          if [ "$VERSION" != "$POETRY_VERSION" ]; then
            VERSION="$POETRY_VERSION"
          fi
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          poetry run mike deploy --push --update-aliases --force "$VERSION" latest
